rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========== HELPER FUNCTIONS ==========
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      let adminPath = /databases/$(database)/documents/admins/$(request.auth.uid);
      return isAuthenticated() && exists(adminPath) && get(adminPath).data.isActive == true;
    }
    
    function isDeliveryPartner() {
      // Allow all requests for delivery partners (custom authentication)
      // The delivery partner app handles authentication validation
      return true;
    }
    
    function isWorkshopWorker() {
      let workshopPath = /databases/$(database)/documents/workshop_workers/$(request.auth.uid);
      return isAuthenticated() && exists(workshopPath) && get(workshopPath).data.isActive == true;
    }
    
    // Enhanced validation function for notifications
    function isValidNotificationCreate() {
      let requiredFields = ['title', 'body', 'type'];
      let validTypes = ['new_order', 'order_edit', 'order_cancellation', 'status_change', 
                       'customer_registration', 'delivery_update', 'workshop_update'];
      
      return request.resource.data.keys().hasAll(requiredFields) &&
             validTypes.hasAny([request.resource.data.type]) &&
             request.resource.data.read == false &&
             request.resource.data.createdAt == request.time;
    }
    
    // Relaxed validation for admin-created notifications
    function isValidAdminNotificationCreate() {
      let requiredFields = ['title', 'body', 'type'];
      let validTypes = ['new_order', 'order_edit', 'order_cancellation', 'status_change', 
                       'customer_registration', 'delivery_update', 'workshop_update'];
      
      return request.resource.data.keys().hasAll(requiredFields) &&
             validTypes.hasAny([request.resource.data.type]) &&
             request.resource.data.read == false;
    }
    
    // Validation for admin editing customer data
    function isValidCustomerEdit() {
      let allowedFields = ['name', 'email', 'phoneNumber', 'updatedAt', 'isProfileComplete'];
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(allowedFields);
    }
    
    // Validation for address updates
    function isValidAddressUpdate() {
      let allowedFields = ['doorNumber', 'floorNumber', 'apartmentName', 'addressLine1', 
                          'addressLine2', 'nearbyLandmark', 'city', 'state', 'pincode', 
                          'latitude', 'longitude', 'isPrimary', 'updatedAt'];
      return request.resource.data.keys().hasAll(['doorNumber', 'addressLine1', 'city', 'state', 'pincode']) &&
             request.resource.data.keys().hasOnly(allowedFields.concat(['createdAt']));
    }
    
    // ========== COLLECTION RULES ==========
    
    // DELIVERY PHONE INDEX: For fast phone number lookups during authentication
    match /delivery_phone_index/{phoneKey} {
      // Allow reading for authentication purposes (unauthenticated access needed for login)
      allow read: if true;
      
      // Allow listing for authentication phone number lookups
      allow list: if true;
      
      // Only admins can create/update/delete phone index records
      allow create, update, delete: if isAdmin();
    }
    
    // ADMINS: Allow phone verification during login and notification access
    match /admins/{adminId} {
      allow read: if true;
      allow update: if isAdmin() || isOwner(adminId);
      allow create: if isOwner(adminId) || isAdmin();
      allow list: if true;
      allow delete: if isAdmin();
      
      // ADMIN NOTIFICATIONS SUBCOLLECTION
      match /notifications/{notificationId} {
        allow read, write: if isAdmin() && isOwner(adminId);
        allow read, list: if isAdmin();
        allow create: if isAuthenticated() && (isValidNotificationCreate() || (isAdmin() && isValidAdminNotificationCreate()));
        allow update: if isAdmin() && isOwner(adminId) && 
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      }
    }

    // DELIVERY PARTNERS: Enhanced rules for phone + code authentication
    match /delivery/{partnerId} {
      // Allow reading for authentication purposes (phone number lookup)
      // This is needed for delivery partners to login without being authenticated first
      allow read: if true;
      
      // Allow listing for delivery partner authentication (phone number lookup)
      allow list: if true;
      
      // Admins have full create/delete access
      allow create, delete: if isAdmin();
      
      // Update permissions for delivery partners:
      // 1. Admins can update anything
      // 2. Allow any updates for login/authentication process (temporary permissive rule)
      allow update: if isAdmin() || true;
      
      // Enhanced delivery partner notifications rules
      match /notifications/{notificationId} {
        allow create: if isAdmin() || 
                     (isAuthenticated() && isValidNotificationCreate()) || 
                     (isWorkshopWorker() && isValidNotificationCreate());
        allow read, list: if isOwner(partnerId) || isAdmin();
        allow update: if isOwner(partnerId) && 
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      }
      
      // Assigned orders subcollection for delivery partners
      match /assigned_orders/{orderId} {
        allow read, write: if isAdmin();
        allow read, list: if isAuthenticated() && resource.data.uid == request.auth.uid;
        allow create: if isAdmin();
        allow update: if isAdmin() || 
                     (isAuthenticated() && resource.data.uid == request.auth.uid);
      }
    }
    
    match /delivery_personnel/{partnerId} {
      allow read: if true;
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || 
                      isOwner(partnerId) ||
                      (isAuthenticated() && resource.data.uid == request.auth.uid);
      allow list: if isAuthenticated();
      
      // Enhanced delivery personnel notifications rules
      match /notifications/{notificationId} {
        allow create: if isAdmin() || 
                     (isAuthenticated() && isValidNotificationCreate()) || 
                     (isWorkshopWorker() && isValidNotificationCreate());
        allow read, list: if isOwner(partnerId) || isAdmin();
        allow update: if isOwner(partnerId) && 
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      }
    }
    
    // WORKSHOP WORKERS: Enhanced rules with notifications
    match /workshop_workers/{workerId} {
      allow read: if true;
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || 
                      isOwner(workerId) ||
                      (isAuthenticated() && resource.data.uid == request.auth.uid);
      allow list: if isAuthenticated();
      
      // Enhanced workshop worker notifications rules
      match /notifications/{notificationId} {
        allow create: if isAdmin() || 
                     (isAuthenticated() && isValidNotificationCreate()) || 
                     (isDeliveryPartner() && isValidNotificationCreate());
        allow read, list: if isOwner(workerId) || isAdmin();
        allow update: if isOwner(workerId) && 
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      }
    }
    
    // CUSTOMERS: Enhanced access for delivery partners
    match /customer/{customerId} { 
      // Delivery partners can read customer data for order fulfillment
      allow read, list: if isDeliveryPartner();
      
      // Allow anyone to read customer data (for delivery partner operations)
      allow read, list: if true;
      
      // Admin has full access
      allow read, write: if isAdmin();
      
      // Customer can create their own account
      allow create: if isAuthenticated() && request.auth.uid == customerId;
      
      // Customer can read and update their own data
      allow read, update: if isOwner(customerId);
      
      // Admin can edit customer profile with validation
      allow update: if isAdmin() && isValidCustomerEdit();
      
      // CUSTOMER ADDRESSES SUBCOLLECTION - Enhanced access for delivery partners
      match /addresses/{addressId} {
        // Delivery partners can read customer addresses for order delivery
        allow read, list: if isDeliveryPartner();
        
        // Allow anyone to read customer addresses (for delivery operations)
        allow read, list: if true;
        
        // Admin has full access to all addresses
        allow read, write: if isAdmin();
        
        // Customer can manage their own addresses
        allow create, read, update, delete: if isOwner(customerId);
        
        // Admin can create/update addresses with validation
        allow create: if isAdmin() && isValidAddressUpdate();
        allow update: if isAdmin() && isValidAddressUpdate();
        
        // Admin can delete addresses
        allow delete: if isAdmin();
      }
    }
    
    // LEGACY: Support for users collection with enhanced delivery partner access
    match /users/{userId} { 
      // Delivery partners can read user data for order fulfillment
      allow read, list: if isDeliveryPartner();
      
      // Allow anyone to read user data (for delivery operations)
      allow read, list: if true;
      
      // Admin has full access
      allow read, write: if isAdmin();
      
      // User can create their own account
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // User can read and update their own data
      allow read, update: if isOwner(userId);
      
      // Admin can edit user profile with validation
      allow update: if isAdmin() && isValidCustomerEdit();
      
      // USER ADDRESSES SUBCOLLECTION - Enhanced access for delivery partners
      match /addresses/{addressId} {
        // Delivery partners can read user addresses for order delivery
        allow read, list: if isDeliveryPartner();
        
        // Allow anyone to read user addresses (for delivery operations)
        allow read, list: if true;
        
        // Admin has full access to all addresses
        allow read, write: if isAdmin();
        
        // User can manage their own addresses
        allow create, read, update, delete: if isOwner(userId);
        
        // Admin can create/update addresses with validation
        allow create: if isAdmin() && isValidAddressUpdate();
        allow update: if isAdmin() && isValidAddressUpdate();
        
        // Admin can delete addresses
        allow delete: if isAdmin();
      }
    }
    
    // ORDERS: Enhanced access for delivery partners
    match /orders/{orderId} { 
      // Delivery partners can read and edit orders for pickup/delivery operations
      allow read, list: if isDeliveryPartner();
      allow update: if isDeliveryPartner();
      
      // Allow anyone to read, write, and update orders (for testing)
      allow read, list, write, create, update, delete: if true;
      
      // Admin has full access
      allow read, write: if isAdmin();
      
      // Customer can create their own orders
      allow create: if isAuthenticated() && request.resource.data.customerId == request.auth.uid;
      
      // Customer can read their own orders
      allow read: if isAuthenticated() && resource.data.customerId == request.auth.uid;
      
      // Workshop workers can read orders
      allow read, list: if isWorkshopWorker();
      
      // Order notifications subcollection - Enhanced permissions
      match /notifications/{notificationId} {
        allow read: if isAdmin() || 
                   (isAuthenticated() && resource.data.forAdmin == false && 
                    get(/databases/$(database)/documents/orders/$(orderId)).data.customerId == request.auth.uid);
        allow create: if isAdmin() || 
                     (isAuthenticated() && isValidNotificationCreate()) ||
                     (isAuthenticated() && 
                      get(/databases/$(database)/documents/orders/$(orderId)).data.customerId == request.auth.uid &&
                      isValidNotificationCreate());
        allow update: if isAdmin() || 
                     (isAuthenticated() && 
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']));
      }
      

    }
    
    // Customer Registration Notifications
    match /customerRegistrationNotifications/{notificationId} {
      allow read: if isAdmin();
      allow create: if isAuthenticated() && (isValidNotificationCreate() || (isAdmin() && isValidAdminNotificationCreate()));
      allow update: if isAdmin();
    }
    
    // Quick Order Notifications with enhanced rules
    match /quickOrderNotifications/{notificationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (isValidNotificationCreate() || (isAdmin() && isValidAdminNotificationCreate()));
      allow update: if isAdmin() || 
                   (isDeliveryPartner() && 
                    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt']));
      allow delete: if isAdmin();
    }
    
    // ITEMS: Enhanced access for delivery partners
    match /items/{doc=**} { 
      // Delivery partners can read and list all items for order management
      allow read, list: if isDeliveryPartner();
      
      // Allow anyone to read items (public access)
      allow read: if true; 
      
      // Only admins can write/modify items
      allow write: if isAdmin();
    }
    
    match /banners/{doc=**} { 
      allow read: if true; 
      allow write: if isAdmin(); 
    }
    
    match /offers/{doc=**} { 
      allow read: if true; 
      allow write: if isAdmin(); 
    }
    
    match /notification/{doc=**} { 
      allow read: if true; 
      allow write: if isAdmin(); 
    }
    
    match /categories/{doc=**} { 
      allow read: if true; 
      allow write: if isAdmin(); 
    }
    
    match /settings/{doc=**} { 
      allow read: if true; 
      allow write: if isAdmin(); 
    }
    
    // ALLIED SERVICES: Customers can view, admins can manage
    match /allied_services/{serviceId} {
      // Customers can read all allied services
      allow read: if isAuthenticated();
      
      // Allow listing for authenticated users (customers)
      allow list: if isAuthenticated();
      
      // Admins have full write access (create, update, delete)
      allow write: if isAdmin();
      
      // Explicitly allow admins to create new services
      allow create: if isAdmin();
      
      // Explicitly allow admins to update existing services
      allow update: if isAdmin();
      
      // Explicitly allow admins to delete services
      allow delete: if isAdmin();
    }
    
    // FEEDBACK: Customers can create feedback, admins can manage all
    match /feedback/{feedbackId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow delete: if isAdmin();
      allow list: if isAdmin();
    }
    
    // FCM NOTIFICATIONS: For sending push notifications
    match /fcm_notifications/{notificationId} {
      // Allow authenticated users to create FCM notifications
      allow create: if isAuthenticated();
      
      // Allow admins to read and manage FCM notifications
      allow read, update, delete: if isAdmin();
      
      // Allow users to read their own FCM notifications
      allow read: if isAuthenticated() && 
                 resource.data.userId == request.auth.uid;
      
      // Allow admins to list all FCM notifications
      allow list: if isAdmin();
    }
    
    // ========== COLLECTION GROUP RULES ==========
    
    // NOTIFICATIONS COLLECTION GROUP: For admin panel to query all notifications
    match /{path=**}/notifications/{notificationId} {
      // Allow admins to read all notifications across all collections
      allow read, list: if isAdmin();
      
      // Allow customers to read their own notifications
      allow read: if isAuthenticated() && 
                 resource.data.forAdmin == false;
      
      // Allow admins to update read status of notifications
      allow update: if isAdmin() && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      
      // Allow customers to update read status of their own notifications
      allow update: if isAuthenticated() && 
        resource.data.forAdmin == false &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
    }
    
    // ADDRESSES COLLECTION GROUP: Open read access for delivery operations
    match /{path=**}/addresses/{addressId} {
      // Allow anyone to read addresses across all collections (for delivery operations)
      allow read, list: if true;
      
      // Allow admins to read all addresses across all collections
      allow read, list: if isAdmin();
    }
  }
}